import{aR as u,aS as R,aT as O,S as h,ad as m,aU as v,n as A,P as i,q as I,L as S,ak as B,M as E,aV as p,H as G,d as T}from"./index-Blwhwd1D.js";import{c as x,u as C}from"./cards-B5bzqs4L.js";const _={"upgrade cost threshold":()=>({index:u.Last,condition:e=>e.effect.tags.includes("upgrade"),use:(e,r)=>e.effect.tags.includes("upgrade")?{...e,effect:{...e.effect,cost:R(r,e)}}:e}),"lowers price of hand cards":(e,r)=>({index:u.AddOrSubtract,condition:n=>e.includes(n.name),use:n=>({...n,effect:{...n.effect,cost:{type:n.effect.cost.type,value:n.effect.cost.value-O({value:r,type:"energy"},n.effect.cost.type)}}})}),"next energy card cost money":()=>({index:u.Last,once:!0,condition:e=>e.effect.cost.type==="energy",use:e=>({...e,effect:{...e.effect,cost:{type:"money",value:Math.ceil(e.effect.cost.value*h)}}})}),"next money card cost energy":()=>({index:u.Last,once:!0,condition:e=>e.effect.cost.type==="money"&&e.effect.cost.value>0,use:(e,r)=>({...e,effect:{...e.effect,cost:{type:"energy",value:Math.min(r.energyMax,Math.ceil(e.effect.cost.value/h))}}})}),"next card half cost":()=>({index:u.MultiplyOrDivide,once:!0,condition:e=>e.effect.cost.value>1,use:e=>({...e,effect:{...e.effect,cost:{type:e.effect.cost.type,value:Math.floor(e.effect.cost.value/2)}}})}),"level up cards":(e,r)=>({index:u.First,condition:n=>e.includes(n.name),use:(n,t,f)=>{const c=n.rarity+r;return{...n,rarity:c,effect:f.effect(m(c,t),t,n)}}}),"all card inflation":()=>({index:u.First,condition:()=>!0,use:(e,r,n)=>{const t=e.rarity-r.inflation;return{...e,rarity:t,effect:n.effect(m(t,r),r,e)}}})};function k(e,r){e.setOperationInProgress("choices",!0);const n=t=>{var f,c;return(e.draw.length===0||e.draw.every(a=>a.name!==t.name))&&(e.discard.length===0||e.discard.every(a=>a.name!==t.name))&&(e.hand.length===0||e.hand.every(a=>a.name!==t.name))&&(!(r!=null&&r.exclude)||((f=r==null?void 0:r.exclude)==null?void 0:f.every(a=>a!==t.name)))&&(!(r!=null&&r.filter)||((c=r==null?void 0:r.filter)==null?void 0:c.call(r,t,e)))&&(!t.effect().tags.includes("upgrade")||e.upgrades.length===0||e.upgrades.every(a=>{const o=w(a);return o.name!==t.name||o.cumul<o.max}))};return{header:(r==null?void 0:r.header)??"Choisis une carte",options:()=>{const t=x.filter(n);if(t.length<e.choiceOptionCount)for(;t.length<e.choiceOptionCount;)t.push(v(e));else if(!(r!=null&&r.noResource)){const f=t.length;for(let c=0;c<Math.ceil(f/10);c++)t.push(v(e))}return A(t,3).slice(0,e.choiceOptionCount).map(f=>i(f)?f:{name:f.name,state:"landing",initialRarity:I()})}}}function F(e){return e.reputation===0?"reputation":e.draw.length===0&&e.hand.length===0?"mill":e.hand.every(r=>{const n=l(r,e);return n.effect.condition&&!n.effect.condition(e,n)?!0:!S(n,e)})&&(e.reputation+e.energy<B||e.hand.length>=E||e.draw.length===0)?e.draw.length===0?"mill-lock":"soft-lock":!1}function j(e,r){let n=l(r,e,{withoutModifiers:!0});const t=e.globalCardModifiers.map(c=>[c,M(c)]).toSorted(([,c],[,a])=>c.index-a.index),f=[];for(const[c,a]of t){if(a.condition&&!a.condition(n,e))continue;const o=n;n=a.use(n,e,g(n.name));const s=n.rarity!==o.rarity,d=n.effect.cost.value!==o.effect.cost.value,y=n.effect.cost.type!==o.effect.cost.type;s&&f.push({reason:c.reason,type:"localAdvantage",before:o.rarity,after:n.rarity}),(d||y)&&f.push({reason:c.reason,type:"cost",before:o.effect.cost,after:n.effect.cost})}return f}function U(e,r,n=!1){const t=e.globalCardModifiers.map(f=>[f,M(f)]).toSorted(([,f],[,c])=>f.index-c.index);for(const[f,c]of t)c.condition&&!c.condition(r,e)||(r=c.use(r,e,g(r.name)),n&&c.once&&e.dangerouslyUpdate({globalCardModifiers:e.globalCardModifiers.filter(a=>a!==f)}));return r}function H(e,r){if(r.effect.tags.includes("ephemeral"))return!0;if(r.effect.tags.includes("upgrade")){const n=C.find(t=>t.name===r.name);if(n.max){if(n.max===1)return!0;const t=e.upgrades.find(c=>c.name===r.name);if(!t)return!1;const f=w(t);return f.cumul>=f.max-1}}return!1}function D(e,r){return e.map(n=>i(n)?n:l(n,r)).toSorted((n,t)=>{if(i(n)&&i(t)){const f=["energy","money","reputation"],c=f.indexOf(n.type),a=f.indexOf(t.type),o=n.value,s=t.value;return c-a||o-s}if(!i(n)&&i(t))return-1;if(i(n)&&!i(t))return 1;if(p(n)&&p(t)){const f=n.type==="action"?1:0,c=t.type==="action"?1:0,a=n.effect.cost.value>0&&n.effect.cost.type==="money"?1:0,o=t.effect.cost.value>0&&t.effect.cost.type==="money"?1:0,s=n.effect.cost.value,d=t.effect.cost.value,y=n.effect.tags.join(",").localeCompare(t.effect.tags.join(","));return f-c||a-o||s-d||y}return 0})}function P(e,r=!1){const n=r?D(e.hand,e):e.hand.map(t=>l(t,e));return{revivedHand:n,revivedDraw:e.draw.map(t=>l(t,e)),revivedDiscard:e.discard.map(t=>l(t,e)),hand:r?n.map(t=>G(t)):e.hand}}function M(e){return _[e.name](...e.params)}function g(e){const r=x.find(n=>n.name===(typeof e=="string"?e:e.name));if(!r)throw new Error(`Card ${e} not found`);return r}function w(e){const r=C.find(n=>n.name===(typeof e=="string"?e:e.name));if(!r)throw new Error(`Upgrade ${e} not found`);return{...r,type:"upgrade",state:typeof e!="string"?e.state:"appear",cumul:typeof e!="string"?e.cumul:1,max:r.max??1/0}}function l(e,r,n){const t=g(e),f=typeof e!="string"?e.initialRarity:T.common,c={...t,type:t.type,state:typeof e!="string"?e.state:null,initialRarity:f,rarity:f},a={...c,effect:t.effect(m(f,r),r,c)};return n!=null&&n.withoutModifiers?a:U(r,a,n==null?void 0:n.clean)}export{U as applyGlobalCardModifiers,k as generateChoiceOptions,j as getGlobalCardModifierLogs,F as isGameOver,g as resolveCard,l as reviveCard,M as reviveCardModifier,w as reviveUpgrade,P as revivedState,D as toSortedCards,H as willBeRemoved};
